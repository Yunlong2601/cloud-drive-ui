{% extends "base.html" %}

{% block title %}Audit Logs - FortiFile{% endblock %}

{% block content %}
<h1>Audit Logs</h1>

{% if suspicious %}
<div class="card mb-3">
    <h3>Suspicious Activity (Last 24h)</h3>
    <table>
        <thead>
            <tr>
                <th>Action</th>
                <th>Failed/Denied Count</th>
            </tr>
        </thead>
        <tbody>
            {% for item in suspicious %}
            <tr>
                <td>{{ item.action }}</td>
                <td><span class="badge badge-danger">{{ item.count }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="card mb-3">
    <h3>Filters</h3>
    <form method="GET" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="action">Action</label>
            <select id="action" name="action">
                <option value="">All Actions</option>
                {% for action in actions %}
                <option value="{{ action }}" {% if request.args.get('action') == action %}selected{% endif %}>{{ action }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="result">Result</label>
            <select id="result" name="result">
                <option value="">All Results</option>
                <option value="success" {% if request.args.get('result') == 'success' %}selected{% endif %}>Success</option>
                <option value="failed" {% if request.args.get('result') == 'failed' %}selected{% endif %}>Failed</option>
                <option value="denied" {% if request.args.get('result') == 'denied' %}selected{% endif %}>Denied</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="user_id">User ID</label>
            <input type="text" id="user_id" name="user_id" value="{{ request.args.get('user_id', '') }}" placeholder="Enter user ID" style="width: 120px;">
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('admin_logs') }}" class="btn btn-secondary">Reset</a>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>User</th>
                <th>Action</th>
                <th>Target</th>
                <th>Result</th>
                <th>IP Address</th>
                <th>Details</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ log.username or 'N/A' }}</td>
                <td>{{ log.action }}</td>
                <td>{{ log.target_type }}{% if log.target_id %} #{{ log.target_id }}{% endif %}</td>
                <td>
                    <span class="badge badge-{% if log.result == 'success' %}success{% elif log.result == 'denied' %}warning{% else %}danger{% endif %}">
                        {{ log.result }}
                    </span>
                </td>
                <td>{{ log.ip_address or 'N/A' }}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ log.details if log.details else 'N/A' }}
                </td>
                <td>
                    <a href="{{ url_for('create_incident', audit_log_id=log.id) }}" class="btn btn-secondary btn-sm">Create Incident</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align: center;">No logs found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&action={{ request.args.get('action', '') }}&result={{ request.args.get('result', '') }}&user_id={{ request.args.get('user_id', '') }}" class="btn btn-secondary">Previous</a>
        {% endif %}
        <span style="padding: 10px;">Page {{ page }}</span>
        {% if logs|length == 50 %}
        <a href="?page={{ page + 1 }}&action={{ request.args.get('action', '') }}&result={{ request.args.get('result', '') }}&user_id={{ request.args.get('user_id', '') }}" class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
</div>
{% endblock %}
